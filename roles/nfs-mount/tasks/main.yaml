---
- name: install nfs client
  apt:
    pkg: nfs-common
    state: latest
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Ensure rpcbind is running
  service:
    name: rpcbind
    state: started
    enabled: true
  become: true

- name: unmount
  mount:
    name: "{{ item.mount }}"
    state: unmounted
  become: true
  with_items:
    - "{{ nfs_mounts }}"

- name: Ensure directory exists
  file:
    path: "{{ item.mount }}"
    state: directory
  become: true
  with_items:
    - "{{ nfs_mounts }}"

- name: configure /etc/fstab on clients
  mount:
    name: "{{ item.mount }}"
    src: "{{ item.url }}"
    fstype: nfs
    opts: noauto,x-systemd.automount,x-systemd.device-timeout=10,x-systemd.idle-timeout=1min,rsize=32768,wsize=32768,timeo=14,hard,intr,tcp
    state: mounted
  become: true
  with_items:
    - "{{ nfs_mounts }}"
